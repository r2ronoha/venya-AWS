<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
	<meta name="description" content="">
	<meta name="author" content="">
	
	<!-- <link rel="icon" href="/static/favicon.ico"> -->
	
	<title>VenYa Create Customer</title>
	
	<!-- Bootstrap core CSS -->
	<link href="/static/css/bootstrap.min.css" rel="stylesheet">
	
	<!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
	<link href="/static/css/ie10-viewport-bug-workaround.css" rel="stylesheet">
	
	<!-- Custom styles for this template -->
	<!-- <link href="/static/css/signin.css" rel="stylesheet"> -->
	<link href="/static/css/arturo_web.css" rel="stylesheet">
	
	<script type="text/javascript" src="/static/common/parsing.js"></script>
	
	<!-- <script src="C:UsersarturoDocumentsR2ROVenYaNode_jsmongodb-testspecialist.js"></script> -->
	<script type="text/javascript">
	var lang = default_lang;
	var myLangTexts;

	function init() {	
		parseUrl();
		
		if ( urlParams["lang"] != undefined && languages.indexOf(urlParams["lang"]) ) {
			lang = urlParams["lang"];
		} 
		myLangTexts = languages_text[lang];

		setFormErrorHeader(urlParams,myLangTexts);
	}

	function create_customer(){
		var form = document.querySelector("form");
		var surname = form.elements.inputSurname.value;
		var firstname = form.elements.inputFirstname.value;
		var email = form.elements.inputEmail.value;
		//var address = form.elements.inputAddress.value;
		var phone = form.elements.inputPhone.value;
		
		var error = {};
		if ( surname == "" ) { error["surname"] = formatMessage([myLangTexts["customer"]["surname"],myLangTexts["errors"]["required"]]); }
		if ( firstname == "" ) { error["firstname"] = formatMessage([myLangTexts["customer"]["firstname"],myLangTexts["errors"]["required"]]); }
		if ( email != "" && ! emailFormat.test(email) ) error["email"] = myLangTexts["errors"]["emailformat"];
		if ( phone != "" && ! phoneFormat.test(phone) ) error["phone"] = myLangTexts["errors"]["phoneformat"];
		phone = phone.replace(/\+/,'%2B');
		
		if ( Object.keys(error).length > 0 ) {
			var errorUrl = location.href.split('?')[0] + "?lang=" + lang + "&status=ERROR&errormessage=input";
			for ( var field in error ) {
				errorUrl += "&" + field + "=" + escape(error[field]);
			}
			//var errorUrl = location.href.hostname + location.href.path;
			//console.log("errorUrl = " + errorUrl);
			location.href = errorUrl;
		} else { 
			var xhr = new XMLHttpRequest();
			var myUrl = "http://" + venya_node_server + ":" + venya_node_port + "/createCustomer?type=customer" + 
			"&firstname=" + firstname.toLowerCase() +
			"&surname=" + surname.toLowerCase() +
			"&email=" + email.toLowerCase() +
			//"&address=" + address + 
			"&phone=" + phone +
			"&language=" + lang;
			//console.log(myUrl);
			xhr.open('GET',myUrl,true);
			//xhr.setRequestHeader('Access-Control-Allow-Origin','*');
			xhr.send();
			xhr.onreadystatechange = processRequest;
		
			function processRequest(e) {
				if (xhr.readyState == 4) {
					if (xhr.status == 200) {
						//console.log(xhr.responseText);
						var response = JSON.parse(xhr.responseText);
						//var successUrl = "./signin.html?action=registration&";
						var successUrl = "./register.html?lang=" + lang + "&action=webcreation&";
						for (var field in response) {
							if ( field != "status" && field != "action" ) {
								var value = response[field];
								if ( value == undefined ) value = "N/A";
								successUrl += field.replace(/_/,'') + "=" + value + "&";
							}
						}
						location.href=successUrl.replace(/&$/,'');
					} else {
						try {
							var response = JSON.parse(xhr.responseText);
							var params = {};
							params["lang"] = lang;
							params["status"] = response["status"];
							params["errormessage"] = response["errormessage"];
							//console.log(params["errormessage"]);
							//goTo(pages.webcreatecustomer,params);
							document.getElementById("errors").innerHTML = formatMessage([myLangTexts["errors"][response["errormessage"]]]);
						} catch (err) {
							document.getElementById("errors").innerHTML = formatMessage([myLangTexts["errors"]["dbcnxerror"]]);
						}
					}
				}
			}
		}
	}
	</script>
	<script type="text/javascript" src="/static/common/languages.js"></script>
</head>

<body>
	<script>init();</script>
	
	<div class="errors" id="errors"></div>
	<div class="container">
	
	<form class="form">
	<h2 id="formHeader" class="form-signin-heading"><script>javascript:displayForm("formHeader",formatMessage([myLangTexts["form"]["enterdetails"]]))</script></h2>
	
	<input type="text" id="inputSurname" class="form-control" placeholder="Surname" required autofocus>
	<label for="inputSurname" class="sr-only"><script>displayForm("inputSurname",formatMessage([myLangTexts["customer"]["surname"]]))</script></label>
	
	<input type="text" id="inputFirstname" class="form-control" placeholder="First Name" required autofocus>
	<label for="inputFirstname" class="sr-only"><script>displayForm("inputFirstname",formatMessage([myLangTexts["customer"]["firstname"]]))</script></label>
	
	<input type="email" id="inputEmail" class="form-control" placeholder="Email address" >
	<label for="inputEmail" class="sr-only"><script>displayForm("inputEmail",formatMessage([myLangTexts["customer"]["email"]]))</script></label>
	
	<input type="text" id="inputPhone" class="form-control" placeholder="Phone number" >
	<label for="inputPhone" class="sr-only"><script>displayForm("inputPhone",formatMessage([myLangTexts["customer"]["phone"]]))</script></label>

	<button id="submitButton" class="btn btn-lg btn-primary btn-block" type="button" onclick="create_customer()"><script>displayForm("submitButton",formatMessage([myLangTexts["form"]["submit"]]))</script></button>
	</form>
	</div>
	
	
	<!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
	<script src="/static/js/ie10-viewport-bug-workaround.js"></script>
</body>
</html>
